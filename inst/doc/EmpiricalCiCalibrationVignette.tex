\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Empirical calibration of confidence intervals},
            pdfauthor={Martijn J. Schuemie, Marc A. Suchard},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\newcommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Empirical calibration of confidence intervals}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Martijn J. Schuemie, Marc A. Suchard}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{2018-11-24}


\begin{document}
\maketitle

{
\setcounter{tocdepth}{2}
\tableofcontents
}
\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

Observational studies are prone to bias, but unfortunately this bias is
often brushed aside with a single comment in the discussion of a paper
and is never quantified. Elsewhere we have proposed using negative
controls (exposure-outcome pairs where the true relative risk is
believed to be one) to produce an empirical bias distribution, and
subsequently calibrate p-values. Here we extend this approach to
calibrated confidence intervals (CIs), which requires the use of
positive controls. Since real positive controls are problematic, we have
generated synthetic positive controls by injection additional
(simulated) outcomes on top of negative controls.

In this document we use an example study to illustrate how CIs can be
calibrated using the \texttt{EmpiricalCalibration} R package. In the
example, we have replicated a previously published new-user cohort study
comparing dabigatran to warfarin for the risk of GI bleeding. The study
does not aply any adjustment for confounding.

The results from this study are available in the package, and can be
loaded using the \texttt{data()} command:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{(southworthReplication)}
\end{Highlighting}
\end{Shaded}

The estimate for the outcome of interest can in this dataset be
identified because \texttt{trueLogRr} is NA:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{outcomeOfInterest <-}\StringTok{ }\NormalTok{southworthReplication[}\KeywordTok{is.na}\NormalTok{(southworthReplication}\OperatorTok{$}\NormalTok{trueLogRr), ]}
\NormalTok{outcomeOfInterest}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   outcomeName trueLogRr      logRr    seLogRr
## 1     GiBleed        NA -0.3575234 0.06668903
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{computeTraditionalCi}\NormalTok{(outcomeOfInterest}\OperatorTok{$}\NormalTok{logRr, outcomeOfInterest}\OperatorTok{$}\NormalTok{seLogRr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        rr        lb        ub 
## 0.6994063 0.6964876 0.7023372
\end{verbatim}

Here we see that the effect estimate for GI bleed for dabigatran versus
warfarin is 0.7, with a very tight CI.

\hypertarget{negative-controls}{%
\section{Negative controls}\label{negative-controls}}

Negative controls are drug-outcome pairs where we believe the drug does
not cause (or prevent) the outcome. In other words, we believe the true
effect size to be a relative risk of 1. We would prefer our negative
controls to have some resemblance with out hypothesis of interest (in
our example dabigatran vs warfarin and GI bleed), and we therefore
typically pick negative controls where the outcome is the same (exposure
controls), or the exposure is the same (outcome controls). In this
example, we have opted for outcome controls, and have identified a set
of outcomes not believed to be caused by either dabigatran or warfarin.
We have executed exactly the same analysis for these outcomes, resulting
in a set of effect size estimates, one per negative control:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{negatives <-}\StringTok{ }\NormalTok{southworthReplication[southworthReplication}\OperatorTok{$}\NormalTok{trueLogRr }\OperatorTok{==}\StringTok{ }\DecValTok{0} \OperatorTok{&}
\StringTok{                                     }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(southworthReplication}\OperatorTok{$}\NormalTok{trueLogRr), ]}
\KeywordTok{head}\NormalTok{(negatives)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                         outcomeName trueLogRr       logRr    seLogRr
## 4                         Neck pain         0 -0.10015508 0.05005106
## 6                Curvature of spine         0  0.01854604 0.08024194
## 10             Dislocation of joint         0 -0.14348342 0.11084576
## 14               Peripheral vertigo         0 -0.03627483 0.08998388
## 21                Effusion of joint         0 -0.20650211 0.06302084
## 25 Urinary tract infectious disease         0 -0.25308826 0.03858693
\end{verbatim}

\hypertarget{positive-controls}{%
\section{Positive controls}\label{positive-controls}}

Positive controls are drug-outcome pairs where we believe the drug does
cause (or prevent) the outcome. In this case we have generated synthetic
positive controls with various true effect sizes. Similar to the
negative controls we have executed exactly the same analysis for these
outcomes, resulting in a set of effect size estimates, one per positive
control:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{data}\NormalTok{(southworthReplication)}
\NormalTok{positives <-}\StringTok{ }\NormalTok{southworthReplication[southworthReplication}\OperatorTok{$}\NormalTok{trueLogRr }\OperatorTok{!=}\StringTok{ }\DecValTok{0} \OperatorTok{&}
\StringTok{                                     }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(southworthReplication}\OperatorTok{$}\NormalTok{trueLogRr), ]}
\KeywordTok{head}\NormalTok{(positives)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          outcomeName trueLogRr     logRr    seLogRr
## 2          Neck pain 1.3862944 1.1466961 0.03324708
## 3          Neck pain 0.6931472 0.5539283 0.03959980
## 5          Neck pain 0.4054651 0.2888025 0.04344616
## 7 Curvature of spine 1.3862944 1.3519970 0.05327228
## 8 Curvature of spine 0.6931472 0.6918903 0.06357177
## 9 Curvature of spine 0.4054651 0.4272736 0.06932738
\end{verbatim}

\hypertarget{plot-control-effect-sizes}{%
\subsection{Plot control effect sizes}\label{plot-control-effect-sizes}}

We can start by creating a forest plot of our controls:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{controls <-}\StringTok{ }\NormalTok{southworthReplication[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(southworthReplication}\OperatorTok{$}\NormalTok{trueLogRr), ]}
\KeywordTok{plotTrueAndObserved}\NormalTok{(controls}\OperatorTok{$}\NormalTok{logRr, controls}\OperatorTok{$}\NormalTok{seLogRr, controls}\OperatorTok{$}\NormalTok{trueLogRr)}
\end{Highlighting}
\end{Shaded}

\includegraphics{../inst/doc/EmpiricalCiCalibrationVignette_files/figure-latex/unnamed-chunk-6-1.pdf}

The thick black lines indicate the true effect size, and the blue and
orange dots and lines represent the effect size estimate and 95\%
confidence intervals of the controls. We see that many controls have a
confidence interval that does not include the true effect size (orange
lines), certainly more than the expected 5\%. This indicates the
analysis has systematic error.

\hypertarget{systematic-error-model}{%
\section{Systematic error model}\label{systematic-error-model}}

\hypertarget{fitting-the-systematic-error-model}{%
\subsection{Fitting the systematic error
model}\label{fitting-the-systematic-error-model}}

We can use the controls to estimate a model for the systematic error:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model <-}\StringTok{ }\KeywordTok{fitSystematicErrorModel}\NormalTok{(controls}\OperatorTok{$}\NormalTok{logRr, controls}\OperatorTok{$}\NormalTok{seLogRr, controls}\OperatorTok{$}\NormalTok{trueLogRr)}
\NormalTok{model}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  meanIntercept      meanSlope logSdIntercept     logSdSlope 
##    -0.06655103     0.93329424    -1.67417066     0.01575879 
## attr(,"CovarianceMatrix")
##               [,1]          [,2]          [,3]          [,4]
## [1,]  5.645229e-04 -0.0005483258  9.364782e-05 -0.0001833231
## [2,] -5.483258e-04  0.0009044631 -1.934024e-04  0.0003556884
## [3,]  9.364782e-05 -0.0001934024  9.131157e-03 -0.0087454417
## [4,] -1.833231e-04  0.0003556884 -8.745442e-03  0.0137776815
## attr(,"LB95CI")
## [1] -0.1131192  0.8743497 -1.8614591 -0.2142986
## attr(,"UB95CI")
## [1] -0.01998289  0.99223878 -1.48688221  0.24581617
## attr(,"class")
## [1] "systematicErrorModel"
\end{verbatim}

We see that the intercept of the mean is slightly lower than 0,
indicating the analysis is negatively biased when the null is true. We
can also visualize the model:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plotErrorModel}\NormalTok{(controls}\OperatorTok{$}\NormalTok{logRr, controls}\OperatorTok{$}\NormalTok{seLogRr, controls}\OperatorTok{$}\NormalTok{trueLogRr)}
\end{Highlighting}
\end{Shaded}

\includegraphics{../inst/doc/EmpiricalCiCalibrationVignette_files/figure-latex/unnamed-chunk-8-1.pdf}

Here we see how systematic error changes as a function of the true
effect size. As visible, the model assumes the mean and standard
deviation (SD) of the error distribution are linearly related to the
true effect size. For this plot, the mean and SD are also estimated at
each true effect size independently, allowing us to evaluate whether the
linearity assumption is far off.

There is also another way to plot the error model, and its subsequent
calibration:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plotCiCalibrationEffect}\NormalTok{(controls}\OperatorTok{$}\NormalTok{logRr, controls}\OperatorTok{$}\NormalTok{seLogRr, controls}\OperatorTok{$}\NormalTok{trueLogRr)}
\end{Highlighting}
\end{Shaded}

\includegraphics[width=1\linewidth]{../inst/doc/EmpiricalCiCalibrationVignette_files/figure-latex/unnamed-chunk-9-1}

\hypertarget{evaluating-the-calibration}{%
\subsection{Evaluating the
calibration}\label{evaluating-the-calibration}}

To evaluate whether our estimation of the systematic error distribution
is a good one, we can test whether the calibrated CI is truly
calibrated, meaning the fraction of controls where truth is inside the
calibrated CI is approximately the specified width of the CI. We also
evaluate `centeredness', whether truth outside of the CI is equally
distributed above and below the CI:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plotCiCoverage}\NormalTok{(controls}\OperatorTok{$}\NormalTok{logRr,}
\NormalTok{               controls}\OperatorTok{$}\NormalTok{seLogRr,}
\NormalTok{               controls}\OperatorTok{$}\NormalTok{trueLogRr,}
               \DataTypeTok{crossValidationGroup =}\NormalTok{ controls}\OperatorTok{$}\NormalTok{outcomeName)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Fitting error models within leave-one-out cross-validation
\end{verbatim}

\includegraphics{../inst/doc/EmpiricalCiCalibrationVignette_files/figure-latex/unnamed-chunk-10-1.pdf}

The data shown here is produced using a leave-one-out cross-validation.
It is important to remember that for this dataset positive controls were
generated based on negative controls and will therefore be correlated.
To perform an unbiased evaluation the `one' in the leave-one-out should
therefore be the group of a negative control \emph{and} its derived
positive controls, and this is achieved by specifying the
\texttt{crossValidationGroup} argument. Thus, in this evaluation for
each negative control and the positive controls derived from that
negative control, we fit systematic error models using all other
controls, and compute calibrated CIs for the left-out controls across a
wide range of widths.

In the graph the dashed lines indicate a perfectly calibrated study. We
see that the calibrated CIs are much closer to the ideal than the
uncalibrated CIs.

\hypertarget{confidence-interval-calibration}{%
\section{Confidence interval
calibration}\label{confidence-interval-calibration}}

\hypertarget{calibrating-the-confidence-interval}{%
\subsection{Calibrating the confidence
interval}\label{calibrating-the-confidence-interval}}

We can now use the estimated systematic error model to compute the
calibrated CI for our outcome of interest:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ci <-}\StringTok{ }\KeywordTok{calibrateConfidenceInterval}\NormalTok{(outcomeOfInterest}\OperatorTok{$}\NormalTok{logRr, outcomeOfInterest}\OperatorTok{$}\NormalTok{seLogRr, model)}
\NormalTok{ci}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        logRr  logLb95Rr logUb95Rr   seLogRr
## 1 -0.3117815 -0.7254078 0.1067071 0.2122781
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{exp}\NormalTok{(ci[,}\DecValTok{1}\OperatorTok{:}\DecValTok{3}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       logRr logLb95Rr logUb95Rr
## 1 0.7321415 0.4841271  1.112608
\end{verbatim}

In this case, even though the point estimate has not changed much, the
calibrated CI is much wider than the uncalibrated one to take in to
account the residual error due to lack of any adjustment for
confounding.

\hypertarget{references}{%
\section{References}\label{references}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{citation}\NormalTok{(}\StringTok{"EmpiricalCalibration"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## To cite EmpiricalCalibration in publications use:
## 
## Schuemie MJ, Ryan PB, DuMouchel W, Suchard MA and Madigan D
## (2014). "Interpreting observational studies: why empirical
## calibration is needed to correct p-values." _Statistics in
## Medicine_, *33*(2), pp. 209-218. <URL:
## http://dx.doi.org/10.1002/sim.5925>.
## 
## Schuemie MJ, Hripcsak G, Ryan PB, Madigan D and Suchard MA (2018).
## "Empirical confidence interval calibration for population-level
## effect estimation studies in observational healthcare data."
## _Proc. Natl. Acad. Sci. U.S.A._, *115*(11), pp. 2571-2577. <URL:
## https://doi.org/10.1073/pnas.1708282114>.
## 
## To see these entries in BibTeX format, use 'print(<citation>,
## bibtex=TRUE)', 'toBibtex(.)', or set
## 'options(citation.bibtex.max=999)'.
\end{verbatim}


\end{document}
