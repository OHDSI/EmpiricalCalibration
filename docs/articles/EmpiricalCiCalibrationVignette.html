<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Empirical calibration of confidence intervals • EmpiricalCalibration</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Empirical calibration of confidence intervals">
<meta property="og:description" content="EmpiricalCalibration">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EmpiricalCalibration</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/EmpiricalCiCalibrationVignette.html">Empirical calibration of confidence intervals</a>
    </li>
    <li>
      <a href="../articles/EmpiricalPCalibrationVignette.html">Empirical calibration of p-values</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/EmpiricalCalibration/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Empirical calibration of confidence intervals</h1>
                        <h4 class="author">Martijn J. Schuemie, Marc A. Suchard</h4>
            
            <h4 class="date">2020-06-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/EmpiricalCalibration/blob/master/vignettes/EmpiricalCiCalibrationVignette.Rmd"><code>vignettes/EmpiricalCiCalibrationVignette.Rmd</code></a></small>
      <div class="hidden name"><code>EmpiricalCiCalibrationVignette.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Observational studies are prone to bias, but unfortunately this bias is often brushed aside with a single comment in the discussion of a paper and is never quantified. Elsewhere we have proposed using negative controls (exposure-outcome pairs where the true relative risk is believed to be one) to produce an empirical bias distribution, and subsequently calibrate p-values. Here we extend this approach to calibrated confidence intervals (CIs). However, this requires us to specify how systematic error changes with true effect size. We currently support two approaches:</p>
<p>The first is for the researcher to specify an assumption, for example to specify that systematic error doesn’t change as a function of true effect size. Although this is likely to be correct in many instances, if an estimation method is for example biased towards the null the assumption will be violated, and the calibrated confidence intervals will have a lower than nominal coverage.</p>
<p>The second approach is to us positive controls to empirically derive how systematic error changes with true effect size. Since real positive controls are problematic, we typically generate synthetic positive controls by injection additional (simulated) outcomes on top of negative controls.</p>
<p>In this document we use an example study to illustrate how CIs can be calibrated using the <code>EmpiricalCalibration</code> R package. In the example, we have replicated a previously published new-user cohort study comparing dabigatran to warfarin for the risk of GI bleeding. The study does not apply any adjustment for confounding.</p>
<p>The results from this study are available in the package, and can be loaded using the <code><a href="https://rdrr.io/r/utils/data.html">data()</a></code> command:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">southworthReplication</span>)</pre></body></html></div>
<p>The estimate for the outcome of interest can in this dataset be identified because <code>trueLogRr</code> is NA:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">outcomeOfInterest</span> <span class="kw">&lt;-</span> <span class="no">southworthReplication</span>[<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">southworthReplication</span>$<span class="no">trueLogRr</span>), ]
<span class="no">outcomeOfInterest</span></pre></body></html></div>
<pre><code>##   outcomeName trueLogRr      logRr    seLogRr
## 1     GiBleed        NA -0.3575234 0.06668903</code></pre>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="../reference/computeTraditionalCi.html">computeTraditionalCi</a></span>(<span class="no">outcomeOfInterest</span>$<span class="no">logRr</span>, <span class="no">outcomeOfInterest</span>$<span class="no">seLogRr</span>)</pre></body></html></div>
<pre><code>##          rr        lb       ub
## 1 0.6994063 0.6137108 0.797068</code></pre>
<p>Here we see that the effect estimate for GI bleed for dabigatran versus warfarin is 0.7, with a very tight CI.</p>
</div>
<div id="negative-controls" class="section level1">
<h1 class="hasAnchor">
<a href="#negative-controls" class="anchor"></a>Negative controls</h1>
<p>Negative controls are drug-outcome pairs where we believe the drug does not cause (or prevent) the outcome. In other words, we believe the true effect size to be a relative risk of 1. We would prefer our negative controls to have some resemblance with out hypothesis of interest (in our example dabigatran vs warfarin and GI bleed), and we therefore typically pick negative controls where the outcome is the same (exposure controls), or the exposure is the same (outcome controls). In this example, we have opted for outcome controls, and have identified a set of outcomes not believed to be caused by either dabigatran or warfarin. We have executed exactly the same analysis for these outcomes, resulting in a set of effect size estimates, one per negative control:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">negatives</span> <span class="kw">&lt;-</span> <span class="no">southworthReplication</span>[<span class="no">southworthReplication</span>$<span class="no">trueLogRr</span> <span class="kw">==</span> <span class="fl">0</span> <span class="kw">&amp;</span>
                                     !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">southworthReplication</span>$<span class="no">trueLogRr</span>), ]
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">negatives</span>)</pre></body></html></div>
<pre><code>##                         outcomeName trueLogRr       logRr    seLogRr
## 4                         Neck pain         0 -0.10015508 0.05005106
## 6                Curvature of spine         0  0.01854604 0.08024194
## 10             Dislocation of joint         0 -0.14348342 0.11084576
## 14               Peripheral vertigo         0 -0.03627483 0.08998388
## 21                Effusion of joint         0 -0.20650211 0.06302084
## 25 Urinary tract infectious disease         0 -0.25308826 0.03858693</code></pre>
</div>
<div id="positive-controls" class="section level1">
<h1 class="hasAnchor">
<a href="#positive-controls" class="anchor"></a>Positive controls</h1>
<p>Positive controls are drug-outcome pairs where we believe the drug does cause (or prevent) the outcome. In this case we have generated synthetic positive controls with various true effect sizes. Similar to the negative controls we have executed exactly the same analysis for these outcomes, resulting in a set of effect size estimates, one per positive control:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">southworthReplication</span>)
<span class="no">positives</span> <span class="kw">&lt;-</span> <span class="no">southworthReplication</span>[<span class="no">southworthReplication</span>$<span class="no">trueLogRr</span> <span class="kw">!=</span> <span class="fl">0</span> <span class="kw">&amp;</span>
                                     !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">southworthReplication</span>$<span class="no">trueLogRr</span>), ]
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">positives</span>)</pre></body></html></div>
<pre><code>##          outcomeName trueLogRr     logRr    seLogRr
## 2          Neck pain 1.3862944 1.1466961 0.03324708
## 3          Neck pain 0.6931472 0.5539283 0.03959980
## 5          Neck pain 0.4054651 0.2888025 0.04344616
## 7 Curvature of spine 1.3862944 1.3519970 0.05327228
## 8 Curvature of spine 0.6931472 0.6918903 0.06357177
## 9 Curvature of spine 0.4054651 0.4272736 0.06932738</code></pre>
<div id="plot-control-effect-sizes" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-control-effect-sizes" class="anchor"></a>Plot control effect sizes</h2>
<p>We can start by creating a forest plot of our controls:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">controls</span> <span class="kw">&lt;-</span> <span class="no">southworthReplication</span>[!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">southworthReplication</span>$<span class="no">trueLogRr</span>), ]
<span class="fu"><a href="../reference/plotTrueAndObserved.html">plotTrueAndObserved</a></span>(<span class="no">controls</span>$<span class="no">logRr</span>, <span class="no">controls</span>$<span class="no">seLogRr</span>, <span class="no">controls</span>$<span class="no">trueLogRr</span>)</pre></body></html></div>
<p><img src="EmpiricalCiCalibrationVignette_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>The thick black lines indicate the true effect size, and the blue and orange dots and lines represent the effect size estimate and 95% confidence intervals of the controls. We see that many controls have a confidence interval that does not include the true effect size (orange lines), certainly more than the expected 5%. This indicates the analysis has systematic error.</p>
</div>
</div>
<div id="systematic-error-model" class="section level1">
<h1 class="hasAnchor">
<a href="#systematic-error-model" class="anchor"></a>Systematic error model</h1>
<div id="fitting-the-empirical-null-and-specifying-an-assumption" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-the-empirical-null-and-specifying-an-assumption" class="anchor"></a>Fitting the empirical null, and specifying an assumption</h2>
<p>If we only have negative controls and no positive controls, we might still want to calibrate CIs. This requires us to make an assumption how systematic error changes as a function of the true effect size. The most obvious (and therefore default) assumption is that the systematic error does not change as a function of true effect size. We can fit the empirical null distribution, and convert it to a systematic error model:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">null</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fitNull.html">fitNull</a></span>(<span class="no">negatives</span>$<span class="no">logRr</span>, <span class="no">negatives</span>$<span class="no">seLogRr</span>)
<span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/convertNullToErrorModel.html">convertNullToErrorModel</a></span>(<span class="no">null</span>)</pre></body></html></div>
<p>See <code><a href="../reference/convertNullToErrorModel.html">?convertNullToErrorModel</a></code> for how to use a different assumption.</p>
</div>
<div id="fitting-the-systematic-error-model-using-positive-controls" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-the-systematic-error-model-using-positive-controls" class="anchor"></a>Fitting the systematic error model using positive controls</h2>
<p>If we do have positive controls, like in this example, we do not have to make an assumption, but instead can estimate the full systematic error model using the estimates for both negative and positive controls:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fitSystematicErrorModel.html">fitSystematicErrorModel</a></span>(<span class="no">controls</span>$<span class="no">logRr</span>, <span class="no">controls</span>$<span class="no">seLogRr</span>, <span class="no">controls</span>$<span class="no">trueLogRr</span>)
<span class="no">model</span></pre></body></html></div>
<pre><code>## meanIntercept     meanSlope   sdIntercept       sdSlope 
##  -0.066550795   0.933292141   0.187468405   0.002979502 
## attr(,"class")
## [1] "systematicErrorModel"</code></pre>
<p>We see that the intercept of the mean (<code>meanIntercept</code>) is slightly lower than 0, indicating the analysis is negatively biased when the null is true. Also note that the slope for the mean (<code>meanSlope</code>) is slightly lower than 1, meaning that the method appears to be somewhat biased towards the null; the negative bias tends to become larger as the true effect size increases.</p>
<p>We can also visualize the model:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu"><a href="../reference/plotErrorModel.html">plotErrorModel</a></span>(<span class="no">controls</span>$<span class="no">logRr</span>, <span class="no">controls</span>$<span class="no">seLogRr</span>, <span class="no">controls</span>$<span class="no">trueLogRr</span>)</pre></body></html></div>
<p><img src="EmpiricalCiCalibrationVignette_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>Here we see how systematic error changes as a function of the true effect size. As visible, the model assumes the mean and standard deviation (SD) of the error distribution are linearly related to the true effect size. For this plot, the mean and SD are also estimated at each true effect size independently, allowing us to evaluate whether the linearity assumption is far off.</p>
<p>There is also another way to plot the error model, and its subsequent calibration:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="../reference/plotCiCalibrationEffect.html">plotCiCalibrationEffect</a></span>(<span class="no">controls</span>$<span class="no">logRr</span>, <span class="no">controls</span>$<span class="no">seLogRr</span>, <span class="no">controls</span>$<span class="no">trueLogRr</span>)</pre></body></html></div>
<p><img src="EmpiricalCiCalibrationVignette_files/figure-html/unnamed-chunk-10-1.png" width="100%"></p>
</div>
<div id="evaluating-the-calibration" class="section level2">
<h2 class="hasAnchor">
<a href="#evaluating-the-calibration" class="anchor"></a>Evaluating the calibration</h2>
<p>To evaluate whether our estimation of the systematic error distribution is a good one, we can test whether the calibrated CI is truly calibrated, meaning the fraction of controls where truth is inside the calibrated CI is approximately the specified width of the CI. We also evaluate ‘centeredness’, whether truth outside of the CI is equally distributed above and below the CI:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="../reference/plotCiCoverage.html">plotCiCoverage</a></span>(<span class="no">controls</span>$<span class="no">logRr</span>,
               <span class="no">controls</span>$<span class="no">seLogRr</span>,
               <span class="no">controls</span>$<span class="no">trueLogRr</span>,
               <span class="kw">crossValidationGroup</span> <span class="kw">=</span> <span class="no">controls</span>$<span class="no">outcomeName</span>)</pre></body></html></div>
<pre><code>## Fitting error models within leave-one-out cross-validation</code></pre>
<p><img src="EmpiricalCiCalibrationVignette_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>The data shown here is produced using a leave-one-out cross-validation. It is important to remember that for this dataset positive controls were generated based on negative controls and will therefore be correlated. To perform an unbiased evaluation the ‘one’ in the leave-one-out should therefore be the group of a negative control <em>and</em> its derived positive controls, and this is achieved by specifying the <code>crossValidationGroup</code> argument. Thus, in this evaluation for each negative control and the positive controls derived from that negative control, we fit systematic error models using all other controls, and compute calibrated CIs for the left-out controls across a wide range of widths.</p>
<p>In the graph the dashed lines indicate a perfectly calibrated study. We see that the calibrated CIs are much closer to the ideal than the uncalibrated CIs.</p>
</div>
</div>
<div id="confidence-interval-calibration" class="section level1">
<h1 class="hasAnchor">
<a href="#confidence-interval-calibration" class="anchor"></a>Confidence interval calibration</h1>
<div id="calibrating-the-confidence-interval" class="section level2">
<h2 class="hasAnchor">
<a href="#calibrating-the-confidence-interval" class="anchor"></a>Calibrating the confidence interval</h2>
<p>We can now use the estimated systematic error model to compute the calibrated CI for our outcome of interest:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">ci</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/calibrateConfidenceInterval.html">calibrateConfidenceInterval</a></span>(<span class="no">outcomeOfInterest</span>$<span class="no">logRr</span>, <span class="no">outcomeOfInterest</span>$<span class="no">seLogRr</span>, <span class="no">model</span>)
<span class="no">ci</span></pre></body></html></div>
<pre><code>##        logRr logLb95Rr logUb95Rr   seLogRr
## 1 -0.3117702 -0.733957 0.1067054 0.2144587</code></pre>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="no">ci</span>[,<span class="fl">1</span>:<span class="fl">3</span>])</pre></body></html></div>
<pre><code>##       logRr logLb95Rr logUb95Rr
## 1 0.7321498 0.4800058  1.112606</code></pre>
<p>In this case, even though the point estimate has not changed much, the calibrated CI is much wider than the uncalibrated one to take in to account the residual error due to lack of any adjustment for confounding.</p>
</div>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/citation.html">citation</a></span>(<span class="st">"EmpiricalCalibration"</span>)</pre></body></html></div>
<pre><code>## 
## To cite EmpiricalCalibration in publications use:
## 
## Schuemie MJ, Ryan PB, DuMouchel W, Suchard MA, Madigan D (2014).
## "Interpreting observational studies: why empirical calibration is
## needed to correct p-values." _Statistics in Medicine_, *33*(2),
## 209-218. &lt;URL: http://dx.doi.org/10.1002/sim.5925&gt;.
## 
## Schuemie MJ, Hripcsak G, Ryan PB, Madigan D, Suchard MA (2018).
## "Empirical confidence interval calibration for population-level effect
## estimation studies in observational healthcare data." _Proc. Natl.
## Acad. Sci. U.S.A._, *115*(11), 2571-2577. &lt;URL:
## https://doi.org/10.1073/pnas.1708282114&gt;.
## 
## To see these entries in BibTeX format, use 'print(&lt;citation&gt;,
## bibtex=TRUE)', 'toBibtex(.)', or set
## 'options(citation.bibtex.max=999)'.</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Martijn Schuemie, Marc Suchard.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
