<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Empirical calibration and MaxSPRT • EmpiricalCalibration</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Empirical calibration and MaxSPRT">
<meta property="og:description" content="EmpiricalCalibration">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EmpiricalCalibration</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/EmpiricalCiCalibrationVignette.html">Empirical calibration of confidence intervals</a>
    </li>
    <li>
      <a href="../articles/EmpiricalMaxSprtCalibrationVignette.html">Empirical calibration and MaxSPRT</a>
    </li>
    <li>
      <a href="../articles/EmpiricalPCalibrationVignette.html">Empirical calibration of p-values</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/EmpiricalCalibration/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="EmpiricalMaxSprtCalibrationVignette_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Empirical calibration and MaxSPRT</h1>
                        <h4 class="author">Martijn J. Schuemie</h4>
            
            <h4 class="date">2021-09-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/EmpiricalCalibration/blob/master/vignettes/EmpiricalMaxSprtCalibrationVignette.Rmd"><code>vignettes/EmpiricalMaxSprtCalibrationVignette.Rmd</code></a></small>
      <div class="hidden name"><code>EmpiricalMaxSprtCalibrationVignette.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>When new drugs or vaccines are brought to market, it is important to continue to monitor their safety. The phase 2 and 3 trials preceding marketing may uncover most common adverse events, but rare adverse events may go undetected due to limited sample size of the trials. Other adverse events may go undetected if they only affect a subpopulation that was excluded from the clinical trials. To catch these types of adverse events requires post-marketing drug and vaccine safety surveillance, for example using routinely collected healthcare data, such as administrative claims and electronic health records. To detect adverse events as quickly as possible, data should be analyzed as it accrues, for example once every month analyzing all data up to that point in time. It is important to realize that such sequential testing for a safety signal is a form of multiple testing that needs to be adjusted for if one aims to maintain the prespecified type 1 error (i.e. if one aims to keep the probability of rejecting the null when the null is true at the specified alpha level). A common approach to adjusting for sequential testing is maximum sequential probability ratio testing (MaxSPRT), used by the U.S Food and Drug Administration (FDA) in its safety surveillance.</p>
<p>However, there is another important reason why the true type 1 error might deviate from the prespecified alpha, and that is systematic error due to the observational nature of the study. Systematic error can manifest from multiple sources, including confounding, selection bias, and measurement error. For example, in a study comparing vaccinated to unvaccinated, the vaccinated group may differ from the unvaccinated one in terms of age and fragility that impact the baseline probability of having the outcome, and failing to adjust for these differences will lead to biased effect size estimates.</p>
<p>This vignette demonstrates combining adjusting for sequential testing through MaxSPRT with adjusting for systematic error using empirical calibration. We use a simulated dataset of survival data for several negative controls and a single positive control.</p>
</div>
<div id="simulated-data" class="section level1">
<h1 class="hasAnchor">
<a href="#simulated-data" class="anchor"></a>Simulated data</h1>
<p>For this vignette we will use simulated data that can be generated using the <code>simulateMaxSprtData</code> function</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">maxSprtSimulationData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulateMaxSprtData.html">simulateMaxSprtData</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">maxSprtSimulationData</span><span class="op">)</span></code></pre></div>
<pre><code>##         time outcome exposure lookTime outcomeId
## 6  5.4443501       0     TRUE       10         1
## 18 5.7940466       0     TRUE       10         1
## 35 7.5386315       0     TRUE       10         1
## 51 5.4168833       0     TRUE       10         1
## 62 0.5159339       0    FALSE       10         1
## 74 9.9375227       0    FALSE       10         1</code></pre>
<p>This is simulated survival data for 50 negative controls (outcome IDs 1-50), and 1 positive control (outcome ID 51). The data provides 10 looks at data accruing over time (at times t = 10, 20, 30, …, 100), with each look having more data than the one before. We simulated moderate systematic error (mean = 0.2, SD = 0,2), and the positive control has a true hazard ratio of 4.</p>
</div>
<div id="maxsprt" class="section level1">
<h1 class="hasAnchor">
<a href="#maxsprt" class="anchor"></a>MaxSPRT</h1>
<p>MaxSPRT (Maximum Sequential Probability Ratio Testing) is a well-known procedure for adjusting for sequential testing. It requires computing the log likelihood ratio (LLR), and comparing it against a prespecified critical value to determine whether there is a signal (suggesting an effect).</p>
<div id="log-likelihood-ratio" class="section level2">
<h2 class="hasAnchor">
<a href="#log-likelihood-ratio" class="anchor"></a>Log likelihood ratio</h2>
<p>In this case, because we have survival data we will use a Cox proportional hazards model. For any outcome, at any look, we can fit a Cox model using the <code>Cyclops</code> package. In this example, we use outcome 51, and the look at t = 50:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ohdsi/cyclops">Cyclops</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span>

<span class="va">dataOutcome51</span> <span class="op">&lt;-</span> <span class="va">maxSprtSimulationData</span><span class="op">[</span><span class="va">maxSprtSimulationData</span><span class="op">$</span><span class="va">outcomeId</span> <span class="op">==</span> <span class="fl">51</span>, <span class="op">]</span>
<span class="va">dataOutcome51LookT50</span> <span class="op">&lt;-</span> <span class="va">dataOutcome51</span><span class="op">[</span><span class="va">dataOutcome51</span><span class="op">$</span><span class="va">lookTime</span> <span class="op">==</span> <span class="fl">50</span>, <span class="op">]</span>

<span class="va">cyclopsData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/createCyclopsData.html">createCyclopsData</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">outcome</span><span class="op">)</span> <span class="op">~</span> <span class="va">exposure</span> , 
                                 modelType <span class="op">=</span> <span class="st">"cox"</span>, 
                                 data <span class="op">=</span> <span class="va">dataOutcome51LookT50</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/fitCyclopsModel.html">fitCyclopsModel</a></span><span class="op">(</span><span class="va">cyclopsData</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## exposureTRUE 
##     1.829709</code></pre>
<p>For MaxSPRT, we’re not interested in the point estimate of the hazard ratio, but rather the LLR. This is the log of the ratio between the maximum likelihood, and the likelihood of the null hypothesis. The maximum likelihood is already available from the <code>fit</code> object:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Maximum log likelihood:</span>
<span class="va">fit</span><span class="op">$</span><span class="va">log_likelihood</span></code></pre></div>
<pre><code>## [1] -1167.396</code></pre>
<p>We can use Cyclops to compute the log likelihood of parameter value 0 (hazard ratio = 1):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">llNull</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/getCyclopsProfileLogLikelihood.html">getCyclopsProfileLogLikelihood</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">fit</span>,
                                         parm <span class="op">=</span> <span class="st">"exposureTRUE"</span>,
                                         x <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">$</span><span class="va">value</span>
<span class="va">llNull</span></code></pre></div>
<pre><code>## [1] -1210.618</code></pre>
<p>And we can compute the LLR by subtracting the two. Note that we use a single-sided test, so we will set LLR to 0 if the point estimate (the maximum likelihood estimate) is below 0. It might also be the case that no maximum likelihood estimate exists, for example because there are zero counts, in which case we also set the LLR to 0:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">return_flag</span> <span class="op">==</span> <span class="st">"ILLCONDITIONED"</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">llr</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">llr</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">log_likelihood</span> <span class="op">-</span> <span class="va">llNull</span>
<span class="op">}</span>
<span class="va">llr</span></code></pre></div>
<pre><code>## [1] 43.22212</code></pre>
</div>
<div id="critical-value" class="section level2">
<h2 class="hasAnchor">
<a href="#critical-value" class="anchor"></a>Critical value</h2>
<p>The critical value for the LLR is computed based on the total number of looks that are expected to be made, and the expected sample size at each look. Because we have already simulated all looks, we will use the actual sample sizes instead of expected ones. For Cox models it is recommended to use the binomial critical value computation:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">outcomesPerLook</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">lookTime</span>, <span class="va">dataOutcome51</span>, <span class="va">sum</span><span class="op">)</span>
<span class="co"># Need incremental outcomes per look:</span>
<span class="va">outcomesPerLook</span> <span class="op">&lt;-</span> <span class="va">outcomesPerLook</span><span class="op">$</span><span class="va">outcome</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">outcomesPerLook</span><span class="op">$</span><span class="va">lookTime</span><span class="op">)</span><span class="op">]</span>
<span class="va">outcomesPerLook</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">outcomesPerLook</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span> <span class="op">-</span> <span class="va">outcomesPerLook</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span>

<span class="va">exposedTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dataOutcome51</span><span class="op">$</span><span class="va">time</span><span class="op">[</span><span class="va">dataOutcome51</span><span class="op">$</span><span class="va">exposure</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">&amp;</span> 
                                        <span class="va">dataOutcome51</span><span class="op">$</span><span class="va">lookTime</span> <span class="op">==</span> <span class="fl">100</span><span class="op">]</span><span class="op">)</span>
<span class="va">unexposedTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dataOutcome51</span><span class="op">$</span><span class="va">time</span><span class="op">[</span><span class="va">dataOutcome51</span><span class="op">$</span><span class="va">exposure</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">&amp;</span> 
                                          <span class="va">dataOutcome51</span><span class="op">$</span><span class="va">lookTime</span> <span class="op">==</span> <span class="fl">100</span><span class="op">]</span><span class="op">)</span>
<span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/computeCvBinomial.html">computeCvBinomial</a></span><span class="op">(</span>groupSizes <span class="op">=</span> <span class="va">outcomesPerLook</span>,
                        z <span class="op">=</span> <span class="va">unexposedTime</span> <span class="op">/</span> <span class="va">exposedTime</span>,
                        minimumEvents <span class="op">=</span> <span class="fl">1</span>,
                        alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></code></pre></div>
<pre><code>## Selected alpha: 0.046 (least conservative value below 0.05)</code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cv</span></code></pre></div>
<pre><code>## [1] 2.689342
## attr(,"alpha")
## [1] 0.04597</code></pre>
<p>By comparing the LLR to the critical value we can determine whether there is a signal:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">llr</span> <span class="op">&gt;</span> <span class="va">cv</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
</div>
<div id="maxsprt-and-empirical-calibration" class="section level1">
<h1 class="hasAnchor">
<a href="#maxsprt-and-empirical-calibration" class="anchor"></a>MaxSPRT and empirical calibration</h1>
<div id="likelihood-profiles" class="section level2">
<h2 class="hasAnchor">
<a href="#likelihood-profiles" class="anchor"></a>Likelihood profiles</h2>
<p>For empirical calibration, we’ll need more than just the likelihood at the maximum and at the null hypothesis. Instead, we’ll need information on the entire likelihood distribution. A convenient way to approximate the likelihood function is the likelihood profile. This profile provides, at various values the hazard ratio, the computed likelihood. The `Cyclops package has a convenient function for computing likelihood profiles:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">llProfileOutcome51LookT50</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/getCyclopsProfileLogLikelihood.html">getCyclopsProfileLogLikelihood</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">fit</span>,
                                                            parm <span class="op">=</span> <span class="st">"exposureTRUE"</span>,
                                                            bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">llProfileOutcome51LookT50</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 2
##   point  value
##   &lt;dbl&gt;  &lt;dbl&gt;
## 1 -2.30 -1411.
## 2 -2.29 -1410.
## 3 -2.29 -1410.
## 4 -2.28 -1409.
## 5 -2.27 -1408.
## 6 -2.26 -1407.</code></pre>
<p>Here we’ve specified that the true hazard ratio is almost certainly in the [0.1, 10] range, so the profile will be restricted to this region. This function uses an adaptive grid, using more grid points if the likelihood shows higher curvature to avoid loss of information.</p>
</div>
<div id="fitting-a-null-distribution-using-likelihood-profiles" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-a-null-distribution-using-likelihood-profiles" class="anchor"></a>Fitting a null distribution using likelihood profiles</h2>
<p>We can fit our null distribution as usual, using the point estimates and standard errors of the negative controls as described in the other vignettes, but when counts are low this may lead to biased estimates of the null distribution parameters. Especially for the earlier looks, we can expect counts to be low, and therefore it is better to take the full likelihood distribution of each negative control into account. Again the likelihood profiles are a convenient way of capturing the full likelihood function. Here we compute the likelihood profile for all negative controls (having outcome IDs 1-50) at time t = 50:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">negativeControlProfilesLookT50</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">dataLookT50</span> <span class="op">&lt;-</span> <span class="va">maxSprtSimulationData</span><span class="op">[</span><span class="va">maxSprtSimulationData</span><span class="op">$</span><span class="va">lookTime</span> <span class="op">==</span> <span class="fl">50</span>, <span class="op">]</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">dataOutcomeIlookT50</span> <span class="op">&lt;-</span> <span class="va">dataLookT50</span><span class="op">[</span><span class="va">dataLookT50</span><span class="op">$</span><span class="va">outcomeId</span> <span class="op">==</span> <span class="va">i</span>, <span class="op">]</span>
  <span class="va">cyclopsData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/createCyclopsData.html">createCyclopsData</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">outcome</span><span class="op">)</span> <span class="op">~</span> <span class="va">exposure</span> , 
                                   modelType <span class="op">=</span> <span class="st">"cox"</span>, 
                                   data <span class="op">=</span> <span class="va">dataOutcomeIlookT50</span><span class="op">)</span>
  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/fitCyclopsModel.html">fitCyclopsModel</a></span><span class="op">(</span><span class="va">cyclopsData</span><span class="op">)</span>
  <span class="va">llProfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/getCyclopsProfileLogLikelihood.html">getCyclopsProfileLogLikelihood</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">fit</span>,
                                              parm <span class="op">=</span> <span class="st">"exposureTRUE"</span>,
                                              bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">negativeControlProfilesLookT50</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">llProfile</span>
<span class="op">}</span></code></pre></div>
<p>We can use these profiles to fit the null distribution:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nullLookT50</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitNullNonNormalLl.html">fitNullNonNormalLl</a></span><span class="op">(</span><span class="va">negativeControlProfilesLookT50</span><span class="op">)</span></code></pre></div>
<pre><code>## Detected data following grid distribution</code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nullLookT50</span></code></pre></div>
<pre><code>## Estimated null distribution
## 
##      Estimate
## Mean   0.3145
## SD     0.1860</code></pre>
<p>This shows substantial systematic error in the negative controls.</p>
</div>
<div id="computing-a-calibrated-log-likelihood-ratio" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-a-calibrated-log-likelihood-ratio" class="anchor"></a>Computing a calibrated log likelihood ratio</h2>
<p>Using the fitted null distribution, and the likelihood profile of our outcome of interest, we can compute the empirically calibrated LLR:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">calibratedLlr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrateLlr.html">calibrateLlr</a></span><span class="op">(</span>null <span class="op">=</span> <span class="va">nullLookT50</span>,
                              likelihoodApproximation <span class="op">=</span> <span class="va">llProfileOutcome51LookT50</span><span class="op">)</span></code></pre></div>
<pre><code>## Detected data following grid distribution</code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">calibratedLlr</span></code></pre></div>
<pre><code>## [1] 14.26661</code></pre>
<p>Which is substantially lower than the uncalibrated LLR we computed earlier (LLR = 43.2221153). We can compare our calibrated LLR to the critical value computed earlier to determine whether there is a signal:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">calibratedLlr</span> <span class="op">&gt;</span> <span class="va">cv</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
</div>
<div id="demonstrating-type-1-error-with-and-without-calibration" class="section level1">
<h1 class="hasAnchor">
<a href="#demonstrating-type-1-error-with-and-without-calibration" class="anchor"></a>Demonstrating type 1 error with and without calibration</h1>
<p>It is always a good idea to compute the type 1 error based on the negative controls, to understand the operating characteristics of your study. Unfortunately, when doing sequential testing we cannot evaluate the overall performance of our surveillance until our final look at the data. Here we compute type 1 error both with and without calibration, comparing it to the nominal type 1 error, to demonstrate why empirical calibration can be important.</p>
<div id="computing-the-calibrated-and-uncalibrated-log-likelihood-ratios" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-the-calibrated-and-uncalibrated-log-likelihood-ratios" class="anchor"></a>Computing the calibrated and uncalibrated log likelihood ratios</h2>
<p>We re-use the example code provided earlier to compute the calibrated and uncalibrated LLR for each negative control at each look. Note that this code will take some time to complete.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">allLlrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">maxSprtSimulationData</span><span class="op">$</span><span class="va">lookTime</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># Compute likelihood profiles for all negative controls:</span>
  <span class="va">negativeControlProfilesLookTt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">dataLookTt</span> <span class="op">&lt;-</span> <span class="va">maxSprtSimulationData</span><span class="op">[</span><span class="va">maxSprtSimulationData</span><span class="op">$</span><span class="va">lookTime</span> <span class="op">==</span> <span class="va">t</span>, <span class="op">]</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">dataOutcomeIlookTt</span> <span class="op">&lt;-</span> <span class="va">dataLookTt</span><span class="op">[</span><span class="va">dataLookTt</span><span class="op">$</span><span class="va">outcomeId</span> <span class="op">==</span> <span class="va">i</span>, <span class="op">]</span>
    <span class="va">cyclopsData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/createCyclopsData.html">createCyclopsData</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">outcome</span><span class="op">)</span> <span class="op">~</span> <span class="va">exposure</span> , 
                                     modelType <span class="op">=</span> <span class="st">"cox"</span>, 
                                     data <span class="op">=</span> <span class="va">dataOutcomeIlookTt</span><span class="op">)</span>
    <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/fitCyclopsModel.html">fitCyclopsModel</a></span><span class="op">(</span><span class="va">cyclopsData</span><span class="op">)</span>
    <span class="va">llProfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/getCyclopsProfileLogLikelihood.html">getCyclopsProfileLogLikelihood</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">fit</span>,
                                                parm <span class="op">=</span> <span class="st">"exposureTRUE"</span>,
                                                bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">negativeControlProfilesLookTt</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">llProfile</span>
  <span class="op">}</span>
  
  <span class="co"># Fit null distribution:</span>
  <span class="va">nullLookTt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitNullNonNormalLl.html">fitNullNonNormalLl</a></span><span class="op">(</span><span class="va">negativeControlProfilesLookTt</span><span class="op">)</span>

  <span class="co"># Compute calibrated and uncalibrated LLRs for all negative controls:</span>
  <span class="va">llrsLookTt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">calibratedLlrsLookTt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">dataOutcomeIlookTt</span> <span class="op">&lt;-</span> <span class="va">dataLookTt</span><span class="op">[</span><span class="va">dataLookTt</span><span class="op">$</span><span class="va">outcomeId</span> <span class="op">==</span> <span class="va">i</span>, <span class="op">]</span>
    <span class="va">cyclopsData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/createCyclopsData.html">createCyclopsData</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">outcome</span><span class="op">)</span> <span class="op">~</span> <span class="va">exposure</span> , 
                                     modelType <span class="op">=</span> <span class="st">"cox"</span>, 
                                     data <span class="op">=</span> <span class="va">dataOutcomeIlookTt</span><span class="op">)</span>
    <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/fitCyclopsModel.html">fitCyclopsModel</a></span><span class="op">(</span><span class="va">cyclopsData</span><span class="op">)</span>
    <span class="va">llProfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/getCyclopsProfileLogLikelihood.html">getCyclopsProfileLogLikelihood</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">fit</span>,
                                                parm <span class="op">=</span> <span class="st">"exposureTRUE"</span>,
                                                bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="co"># Calibrated LLR:</span>
    <span class="va">calibrateLlr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrateLlr.html">calibrateLlr</a></span><span class="op">(</span>null <span class="op">=</span> <span class="va">nullLookTt</span>, 
                 likelihoodApproximation <span class="op">=</span> <span class="va">llProfile</span><span class="op">)</span>
    <span class="va">calibratedLlrsLookTt</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">calibrateLlr</span>
    
    <span class="co"># Uncalibrated LLR:</span>
    <span class="va">llNull</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Cyclops/man/getCyclopsProfileLogLikelihood.html">getCyclopsProfileLogLikelihood</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">fit</span>,
                                             parm <span class="op">=</span> <span class="st">"exposureTRUE"</span>,
                                             x <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">$</span><span class="va">value</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">return_flag</span> <span class="op">==</span> <span class="st">"ILLCONDITIONED"</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">llr</span> <span class="op">&lt;-</span> <span class="fl">0</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="va">llr</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">log_likelihood</span> <span class="op">-</span> <span class="va">llNull</span>
    <span class="op">}</span>
    <span class="va">llrsLookTt</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">llr</span>
  <span class="op">}</span>
  
  <span class="co"># Store in a data frame:</span>
  <span class="va">allLlrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">allLlrs</span>,
                   <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>t <span class="op">=</span> <span class="va">t</span>,
                              outcomeId <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,
                              llr <span class="op">=</span> <span class="va">llrsLookTt</span>,
                              calibrateLlr <span class="op">=</span> <span class="va">calibratedLlrsLookTt</span><span class="op">)</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
<p>Here, for clarity we fit the Cox model and compute the likelihood profiles twice, once for fitting the null distribution, and once to compute the LLRs. Of course it would be more efficient to remove this duplication, but it might make the code harder to read.</p>
</div>
<div id="computing-critical-values-for-all-negative-controls" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-critical-values-for-all-negative-controls" class="anchor"></a>Computing critical values for all negative controls</h2>
<p>We re-use the code shown earlier to compute the critical value for each negative control:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cvs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">dataOutcomeI</span> <span class="op">&lt;-</span> <span class="va">maxSprtSimulationData</span><span class="op">[</span><span class="va">maxSprtSimulationData</span><span class="op">$</span><span class="va">outcomeId</span> <span class="op">==</span> <span class="va">i</span>, <span class="op">]</span>
  <span class="va">outcomesPerLook</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">lookTime</span>, <span class="va">dataOutcomeI</span>, <span class="va">sum</span><span class="op">)</span>
  <span class="co"># Need incremental outcomes per look:</span>
  <span class="va">outcomesPerLook</span> <span class="op">&lt;-</span> <span class="va">outcomesPerLook</span><span class="op">$</span><span class="va">outcome</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">outcomesPerLook</span><span class="op">$</span><span class="va">lookTime</span><span class="op">)</span><span class="op">]</span>
  <span class="va">outcomesPerLook</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">outcomesPerLook</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span> <span class="op">-</span> <span class="va">outcomesPerLook</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span>
  
  <span class="va">exposedTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dataOutcomeI</span><span class="op">$</span><span class="va">time</span><span class="op">[</span><span class="va">dataOutcomeI</span><span class="op">$</span><span class="va">exposure</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">&amp;</span> 
                                         <span class="va">dataOutcomeI</span><span class="op">$</span><span class="va">lookTime</span> <span class="op">==</span> <span class="fl">100</span><span class="op">]</span><span class="op">)</span>
  <span class="va">unexposedTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dataOutcomeI</span><span class="op">$</span><span class="va">time</span><span class="op">[</span><span class="va">dataOutcomeI</span><span class="op">$</span><span class="va">exposure</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">&amp;</span> 
                                            <span class="va">dataOutcomeI</span><span class="op">$</span><span class="va">lookTime</span> <span class="op">==</span> <span class="fl">100</span><span class="op">]</span><span class="op">)</span>
  <span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/computeCvBinomial.html">computeCvBinomial</a></span><span class="op">(</span>groupSizes <span class="op">=</span> <span class="va">outcomesPerLook</span>,
                          z <span class="op">=</span> <span class="va">unexposedTime</span> <span class="op">/</span> <span class="va">exposedTime</span>,
                          minimumEvents <span class="op">=</span> <span class="fl">1</span>,
                          alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>
  <span class="va">cvs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cv</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="computing-overall-type-1-error" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-overall-type-1-error" class="anchor"></a>Computing overall type 1 error</h2>
<p>We compare the computed LLRs to the computed critical values to determine how often a signal is generated for the negative controls (where the null hypothesis is true):</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">signals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">calibratedSignals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">cv</span> <span class="op">&lt;-</span> <span class="va">cvs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
  <span class="va">signals</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">allLlrs</span><span class="op">$</span><span class="va">llr</span><span class="op">[</span><span class="va">allLlrs</span><span class="op">$</span><span class="va">outcomeId</span> <span class="op">==</span> <span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">cv</span><span class="op">)</span>
  <span class="va">calibratedSignals</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">allLlrs</span><span class="op">$</span><span class="va">calibrateLlr</span><span class="op">[</span><span class="va">allLlrs</span><span class="op">$</span><span class="va">outcomeId</span> <span class="op">==</span> <span class="va">i</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">cv</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># Type 1 error when not calibrated (should be 0.05):</span>
<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">signals</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.34</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Type 2 error when calibrated (should be 0.05):</span>
<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">calibratedSignals</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.02</code></pre>
<p>This shows that type 1 error is much closer to nominal when using empirical calibration.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Martijn Schuemie, Marc Suchard.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
